---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { ingredients, cookingPairs } from "@/lib/data";
import type { Ingredient } from "../../types";
import { buildTitle, buildDescription } from "../../lib/seo";
import { getDensityRangeGPerMl } from "../../lib/density";
import { formatNumber } from "../../lib/units";
import { categoryGuides, chartByIngredient, guideByIngredient, variantSlugsByBase } from "@/lib/site-data";

export const prerender = true;

export function getStaticPaths() {
  const ING = ingredients as Ingredient[];
  return ING.map(i => ({ params: { slug: i.slug } }));
}

const ING = ingredients as Ingredient[];
const { slug } = Astro.params;
const ingredient = ING.find(i => i.slug === slug);
if (!ingredient) throw new Error("Ingredient not found");

const range = getDensityRangeGPerMl(ingredient);
const title = buildTitle([ingredient.name, "conversions"]);
const description = buildDescription(`Common conversions for ${ingredient.name}. Density varies by type and packing; see typical ranges and assumptions.`);

const primaryGuide = guideByIngredient[ingredient.slug] ?? "why-density-matters-in-cooking";
const secondaryGuide = (categoryGuides[ingredient.category] ?? ["common-cooking-measurement-mistakes"])
  .find((g) => g !== primaryGuide) ?? "common-cooking-measurement-mistakes";
const chartSlug = chartByIngredient[ingredient.slug];
const variantSlugs = variantSlugsByBase[ingredient.slug] ?? [];
const variantSlugSet = new Set(Object.values(variantSlugsByBase).flat());
const isVariant = variantSlugSet.has(ingredient.slug);

const pairSet = new Set(cookingPairs.map((p) => `${p.from}-${p.to}`));
const desiredPairs = [
  { from: "cup", to: "g" },
  { from: "tbsp", to: "g" },
  { from: "tsp", to: "g" },
  { from: "oz", to: "g" },
  { from: "ml", to: "g" },
  { from: "g", to: "oz" },
  { from: "g", to: "tbsp" },
];
const topConversions = desiredPairs
  .filter((pair) => pairSet.has(`${pair.from}-${pair.to}`))
  .slice(0, 6);
---
<BaseLayout title={title} description={description}>
  <section class="mb-6 sm:mb-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">{ingredient.name}</h1>
    <p class="mt-2 text-lg text-slate-700 max-w-3xl">{ingredient.notes}</p>
    <div class="mt-4 flex flex-wrap gap-2">
      <a class="btn-primary no-underline" href={`/cooking/${ingredient.slug}/`}>View conversions</a>
      {chartSlug && (
        <a class="btn-ghost no-underline" href={`/charts/${chartSlug}/`}>Printable chart</a>
      )}
    </div>
  </section>

  <section class="card card-pad mb-6 sm:mb-8">
    <div class="text-sm text-slate-600">Density range (g/mL)</div>
    <div class="mt-1 text-2xl font-semibold">
      {formatNumber(range.min, 3)} – {formatNumber(range.max, 3)}
    </div>
    <div class="mt-3 text-sm text-slate-600">Known variants</div>
    <ul class="mt-2 space-y-1 text-sm">
      {ingredient.variants.map(v => (
        <li><span class="font-medium">{v.label}:</span> {formatNumber(v.density_g_ml, 3)} g/mL</li>
      ))}
    </ul>
  </section>

  {variantSlugs.length > 0 && (
    <section class="card card-pad mb-6 sm:mb-8">
      <h2 class="text-lg font-bold mb-3">Variants</h2>
      <div class="flex flex-wrap gap-2">
        {variantSlugs.map((v) => (
          <a class="badge no-underline hover:bg-slate-50" href={`/ingredients/${v}/`}>{v.replace(/-/g, " ")}</a>
        ))}
      </div>
    </section>
  )}

  {isVariant && (
    <section class="card card-pad mb-6 sm:mb-8">
      <h2 class="text-lg font-bold mb-2">Why this variant differs</h2>
      <p class="text-slate-700">{ingredient.notes}</p>
    </section>
  )}

  <section class="grid gap-4 lg:grid-cols-3 mb-6 sm:mb-8">
    <article class="card card-pad">
      <h2 class="text-lg font-bold mb-3">Quick actions</h2>
      <div class="flex flex-col gap-2">
        <a class="btn-ghost no-underline" href="/ingredients/browse/">Browse all ingredients</a>
        {chartSlug && <a class="btn-ghost no-underline" href={`/charts/${chartSlug}/`}>View chart</a>}
        <a class="btn-primary no-underline" href={`/guides/${primaryGuide}/`}>Read guide</a>
      </div>
    </article>

    <article class="card card-pad lg:col-span-2">
      <h2 class="text-lg font-bold mb-3">Top conversions</h2>
      <div class="flex flex-wrap gap-2">
        {topConversions.map((pair) => (
          <a class="badge no-underline hover:bg-slate-50" href={`/cooking/${ingredient.slug}/${pair.from}-to-${pair.to}/`}>
            {pair.from} → {pair.to}
          </a>
        ))}
      </div>
    </article>
  </section>

  <section class="card card-pad">
    <h2 class="text-lg font-bold mb-3">Learn</h2>
    <div class="grid gap-3 sm:grid-cols-2">
      <a class="card hover:shadow-md transition" href={`/guides/${primaryGuide}/`}>
        <div class="card-pad">
          <p class="text-sm text-slate-600">Guide</p>
          <p class="font-semibold text-slate-900">{primaryGuide.replace(/-/g, " ")}</p>
        </div>
      </a>
      {chartSlug ? (
        <a class="card hover:shadow-md transition" href={`/charts/${chartSlug}/`}>
          <div class="card-pad">
            <p class="text-sm text-slate-600">Chart</p>
            <p class="font-semibold text-slate-900">{chartSlug.replace(/-/g, " ")}</p>
          </div>
        </a>
      ) : (
        <a class="card hover:shadow-md transition" href={`/guides/${secondaryGuide}/`}>
          <div class="card-pad">
            <p class="text-sm text-slate-600">Guide</p>
            <p class="font-semibold text-slate-900">{secondaryGuide.replace(/-/g, " ")}</p>
          </div>
        </a>
      )}
    </div>
  </section>
</BaseLayout>
