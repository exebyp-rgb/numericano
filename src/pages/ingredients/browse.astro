---
import BaseLayout from "@/layouts/BaseLayout.astro";
import IngredientCard from "@/components/IngredientCard.astro";
import { ingredients } from "@/lib/data";
import { getDensityRangeGPerMl } from "@/lib/density";
import { formatNumber } from "@/lib/units";
import { chartByIngredient, guideByIngredient, variantSlugsByBase } from "@/lib/site-data";

const title = "Browse all ingredients";
const description = "Complete list of all cooking ingredients with density data and conversion tools.";

const variantSlugSet = new Set(Object.values(variantSlugsByBase).flat());
const categoryLabels = Array.from(new Set(ingredients.map((ing) => ing.category)));
const formatRange = (min: number, max: number) => `${formatNumber(min, 3)} â€“ ${formatNumber(max, 3)} g/mL`;
---

<BaseLayout title={title} description={description}>
  <section class="mb-6 sm:mb-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">Browse all ingredients</h1>
    <p class="mt-2 text-lg text-slate-700">Search, filter, and explore ingredient density data.</p>
  </section>

  <section class="card card-pad mb-6">
    <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
      <div class="flex-1">
        <label class="block text-sm font-semibold text-slate-700" for="ingredient-search">Search</label>
        <input
          id="ingredient-search"
          type="search"
          placeholder="Search ingredients..."
          class="mt-2 w-full rounded-xl border-slate-200"
        />
      </div>
      <div class="flex flex-col gap-2">
        <span class="text-sm font-semibold text-slate-700">Variants</span>
        <div class="inline-flex rounded-full border border-slate-200 p-1 text-sm" role="group">
          <button class="px-3 py-1 rounded-full bg-slate-900 text-white" data-variant-toggle="base">Base only</button>
          <button class="px-3 py-1 rounded-full text-slate-700" data-variant-toggle="all">Include variants</button>
        </div>
      </div>
      <div class="text-sm text-slate-600">
        <span id="ingredient-count">Showing 0 of 0</span>
      </div>
    </div>

    <div class="mt-4 flex flex-wrap gap-2">
      <button class="badge bg-slate-900 text-white" data-category="all">All</button>
      {categoryLabels.map((cat) => (
        <button class="badge" data-category={cat}>{cat.replace(/-/g, " ")}</button>
      ))}
    </div>
  </section>

  <section id="ingredient-grid" class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
    {ingredients.map((ing) => {
      const range = getDensityRangeGPerMl(ing);
      const hasVariants = (variantSlugsByBase[ing.slug] ?? []).length > 0;
      const isVariant = variantSlugSet.has(ing.slug);
      return (
        <IngredientCard
          ingredient={ing}
          densityRange={formatRange(range.min, range.max)}
          hasVariants={hasVariants}
          isVariant={isVariant}
          chartSlug={chartByIngredient[ing.slug]}
          guideSlug={guideByIngredient[ing.slug]}
        />
      );
    })}
  </section>

  <script is:inline>
    const searchInput = document.getElementById("ingredient-search");
    const countEl = document.getElementById("ingredient-count");
    const cards = Array.from(document.querySelectorAll("[data-ingredient-card]"));
    const categoryButtons = Array.from(document.querySelectorAll("[data-category]"));
    const variantButtons = Array.from(document.querySelectorAll("[data-variant-toggle]"));

    let activeCategory = "all";
    let includeVariants = false;

    const totalAll = cards.length;
    const totalBase = cards.filter((card) => card.dataset.variant !== "true").length;

    function updateCounts(visible) {
      const total = includeVariants ? totalAll : totalBase;
      countEl.textContent = `Showing ${visible} of ${total}`;
    }

    function applyFilters() {
      const query = (searchInput.value || "").trim().toLowerCase();
      let visible = 0;

      cards.forEach((card) => {
        const name = card.dataset.name || "";
        const category = card.dataset.category || "";
        const isVariant = card.dataset.variant === "true";

        const matchesQuery = !query || name.includes(query);
        const matchesCategory = activeCategory === "all" || category === activeCategory;
        const matchesVariant = includeVariants || !isVariant;

        const show = matchesQuery && matchesCategory && matchesVariant;
        card.classList.toggle("hidden", !show);
        if (show) visible += 1;
      });

      updateCounts(visible);
    }

    categoryButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        categoryButtons.forEach((b) => b.classList.remove("bg-slate-900", "text-white"));
        btn.classList.add("bg-slate-900", "text-white");
        activeCategory = btn.dataset.category || "all";
        applyFilters();
      });
    });

    variantButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        variantButtons.forEach((b) => b.classList.remove("bg-slate-900", "text-white"));
        btn.classList.add("bg-slate-900", "text-white");
        includeVariants = btn.dataset.variantToggle === "all";
        applyFilters();
      });
    });

    searchInput.addEventListener("input", applyFilters);
    applyFilters();
  </script>
</BaseLayout>
