---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { ingredients, cookingPairs } from "@/lib/data";
import { chartByIngredient, guideByIngredient } from "@/lib/site-data";

export const prerender = true;

// Supported conversion units
const VOLUME_UNITS = ["tsp", "tbsp", "cup", "ml"] as const;
const MASS_UNITS = ["g", "oz"] as const;
type Volume = typeof VOLUME_UNITS[number];
type Mass = typeof MASS_UNITS[number];
type Unit = Volume | Mass;

const ML_PER: Record<Volume, number> = {
  tsp: 4.92892159375,
  tbsp: 14.78676478125,
  cup: 236.5882365,
  ml: 1,
};

const G_PER: Record<Exclude<Mass, "g">, number> = {
  oz: 28.349523125,
};

function volumeToMl(amt: number, unit: Volume): number {
  return amt * ML_PER[unit];
}

function mlToVolume(ml: number, unit: Volume): number {
  return ml / ML_PER[unit];
}

function massToG(amt: number, unit: Mass): number {
  if (unit === "g") return amt;
  return amt * G_PER[unit];
}

function gToUnit(g: number, unit: Mass): number {
  if (unit === "g") return g;
  return g / G_PER[unit];
}

function fmt(n: number): string {
  return n.toFixed(2).replace(/\.?0+$/, "");
}

function convert(amt: number, from: Unit, to: Unit, density: number): number {
  const isFromVol = VOLUME_UNITS.includes(from as Volume);
  const isToVol = VOLUME_UNITS.includes(to as Volume);

  if (isFromVol && isToVol) {
    const ml = volumeToMl(amt, from as Volume);
    return mlToVolume(ml, to as Volume);
  }

  if (!isFromVol && !isToVol) {
    const g = massToG(amt, from as Mass);
    return gToUnit(g, to as Mass);
  }

  if (isFromVol && !isToVol) {
    const ml = volumeToMl(amt, from as Volume);
    const g = ml * density;
    return gToUnit(g, to as Mass);
  }

  const g = massToG(amt, from as Mass);
  const ml = g / density;
  return mlToVolume(ml, to as Volume);
}

export async function getStaticPaths() {
  const paths: Array<{ params: { ingredient: string; from: string; to: string } }> = [];
  
  for (const ing of ingredients) {
    for (const pair of cookingPairs) {
      paths.push({
        params: {
          ingredient: ing.slug,
          from: pair.from,
          to: pair.to,
        },
      });
    }
  }
  
  return paths;
}

const { ingredient, from, to } = Astro.params;

const ing = ingredients.find((i) => i.slug === ingredient);
const ENABLED_PAIRS = cookingPairs;
const pairExists = ENABLED_PAIRS.some((p) => p.from === from && p.to === to);

// Check if ingredient or pair is not found/allowed
const isFallback = !ing || !pairExists;

let title: string;
let description: string;
let canonicalUrl: string;
let defaultVariant: any;
let density: number;
let relatedPairs: any[] = [];
let conversions: any[] = [];
let oneUnitValue: number;
let subtitle: string;
let faq: Array<{ q: string; a: string }> = [];
let relatedLinks: Array<{ label: string; href: string }> = [];
let guideSlug: string;
let chartSlug: string | undefined;

if (!isFallback) {
  defaultVariant = ing.variants.find((v) => v.key === ing.defaultVariant) || ing.variants[0];
  density = defaultVariant.density_g_ml;

  // Build related conversions (from enabled pairs, excluding current pair)
  relatedPairs = ENABLED_PAIRS.filter(
    (p) => !(p.from === from && p.to === to)
  ).slice(0, 6);

  const commonAmounts = [0.25, 0.5, 1, 2, 3];
  conversions = commonAmounts.map((amt) => ({
    from: `${fmt(amt)} ${from}`,
    to: `${fmt(convert(amt, from as Unit, to as Unit, density))} ${to}`,
  }));

  oneUnitValue = convert(1, from as Unit, to as Unit, density);
  subtitle = `1 ${from} ${ing.name.toLowerCase()} ≈ ${fmt(oneUnitValue)} ${to}`;
  faq = [
    {
      q: `Why does ${from} of ${ing.name} vary in ${to}?`,
      a: `Different packing densities, temperature, and moisture content affect how much ${ing.name} weighs per volume. This converter uses the typical density of ${defaultVariant.label} (${density} g/ml), but real-world results may vary.`,
    },
    {
      q: "Is this exact for every recipe?",
      a: `This converter gives typical ${to} for ${from} of ${ing.name}, but precision depends on how the ingredient was measured and packed. For baking and other precision work, weighing ${ing.name} directly is best.`,
    },
  ];
  relatedLinks = relatedPairs.map((pair) => ({
    label: `${pair.from} → ${pair.to}`,
    href: `/cooking/${ing.slug}/${pair.from}-to-${pair.to}/`,
  }));

  guideSlug = guideByIngredient[ing.slug] ?? "why-density-matters-in-cooking";
  chartSlug = chartByIngredient[ing.slug];

  title = `${ing.name}: ${from} to ${to} conversion`;
  description = subtitle;
  canonicalUrl = `https://numericano.com/cooking/${ingredient}/${from}-to-${to}/`;
} else {
  title = "Conversion Not Found";
  description = "This conversion is not available. Browse all ingredients or conversions.";
  canonicalUrl = "https://numericano.com/cooking/";
}
---

<BaseLayout title={title} description={description}>
  <link rel="canonical" href={canonicalUrl} slot="head" />
  {isFallback && <meta name="robots" content="noindex,follow" slot="head" />}
  
  {isFallback ? (
    <>
      <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">Conversion Not Found</h1>
      <p class="text-slate-600 mb-4">
        The conversion you're looking for is not available.
      </p>
      
      <div class="flex flex-wrap gap-3">
        <a href="/cooking/" class="btn-ghost no-underline">← Back to Cooking Hub</a>
        <a href="/ingredients/browse/" class="btn-primary no-underline">Browse All Ingredients</a>
      </div>
    </>
  ) : (
    <>
      <div class="mb-4 text-sm text-slate-600">
        <a class="no-underline" href="/">Home</a>
        <span class="mx-2">→</span>
        <a class="no-underline" href="/cooking/">Cooking</a>
        <span class="mx-2">→</span>
        <a class="no-underline" href={`/cooking/${ingredient}/`}>{ing.name}</a>
        <span class="mx-2">→</span>
        <span class="text-slate-900 font-semibold">{from} to {to}</span>
      </div>

      <section class="mb-6 sm:mb-8">
        <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">{ing.name}: {from} to {to}</h1>
        <p class="mt-2 text-lg text-slate-700">{subtitle}</p>

        <div class="mt-4 flex flex-wrap gap-2">
          <span class="badge">Ingredient: <b class="text-slate-900">{ing.name}</b></span>
          <span class="badge">Density used: <b class="text-slate-900">{density} g/ml</b></span>
          <span class="badge">Units: <b class="text-slate-900">{from} → {to}</b></span>
        </div>
      </section>

      <section class="card card-pad mb-6 sm:mb-8">
        <div class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
          <div>
            <div class="text-sm font-semibold text-slate-700">Calculator</div>
            <div class="mt-1 kpi" id="result" data-value={oneUnitValue}>{fmt(oneUnitValue)}</div>
            <div class="kpi-sub">Result in <b>{to}</b>. Assumes density and typical packing.</div>
          </div>

          <div class="flex flex-col sm:flex-row gap-3 sm:items-end">
            <label class="block">
              <div class="text-xs font-semibold text-slate-600 mb-1">Amount ({from})</div>
              <input
                id="amount"
                type="number"
                inputmode="decimal"
                value="1"
                min="0"
                class="w-44 rounded-xl border-slate-200"
              />
            </label>

            <a class="btn-ghost no-underline" href={`/cooking/${ing.slug}/`}>More conversions</a>
          </div>
        </div>

        <script is:inline>
          const amount = document.getElementById("amount");
          const result = document.getElementById("result");
          const valuePer1 = Number(result.dataset.value || "0");

          function fmt(n) {
            return n.toFixed(2).replace(/\.?0+$/, "");
          }

          function update() {
            const x = Number(amount.value || 0);
            const y = x * valuePer1;
            result.textContent = Number.isFinite(y) ? fmt(y) : "—";
          }

          amount.addEventListener("input", update);
          update();
        </script>
      </section>

      <section class="card card-pad mb-6 sm:mb-8">
        <div class="flex items-center justify-between gap-3 mb-3">
          <h2 class="text-lg font-bold">Quick table</h2>
          <span class="text-sm text-slate-600">Common amounts</span>
        </div>

        <table class="table">
          <thead>
            <tr>
              <th>{from}</th>
              <th>{to}</th>
            </tr>
          </thead>
          <tbody>
            {conversions.map((c) => (
              <tr>
                <td>{c.from}</td>
                <td class="font-semibold">{c.to}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </section>

      <section class="card card-pad mb-6 sm:mb-8">
        <h2 class="text-lg font-bold mb-3">Related conversions</h2>
        <div class="flex flex-wrap gap-2">
          {relatedLinks.map((r) => (
            <a class="badge no-underline hover:bg-slate-50" href={r.href}>{r.label}</a>
          ))}
        </div>
      </section>

      <section class="card card-pad mb-6 sm:mb-8">
        <h2 class="text-lg font-bold mb-3">FAQ</h2>
        <div class="space-y-2">
          {faq.map((item) => (
            <details class="rounded-xl border border-slate-200 p-3">
              <summary class="cursor-pointer font-semibold text-slate-900">{item.q}</summary>
              <p class="mt-2 text-slate-700">{item.a}</p>
            </details>
          ))}
        </div>
      </section>

      <section class="card card-pad">
        <h2 class="text-lg font-bold mb-3">Learn</h2>
        <div class="flex flex-wrap gap-2">
          <a class="btn-ghost no-underline" href={`/ingredients/${ing.slug}/`}>Ingredient page</a>
          <a class="btn-primary no-underline" href={`/guides/${guideSlug}/`}>Read guide</a>
          {chartSlug && (
            <a class="btn-ghost no-underline" href={`/charts/${chartSlug}/`}>Printable chart</a>
          )}
        </div>
      </section>
    </>
  )}
</BaseLayout>
