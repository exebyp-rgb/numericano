---
import ingredients from "../../../../data/ingredients.json";
import pairs from "../../../../data/cookingPairs.json";
import { volumeToMass, fmt } from "../../../lib/convert";

type IngredientVariant = { name: string; density: number };
type Ingredient = { slug: string; name: string; notes: string; variants: IngredientVariant[] };
type Pair = { from: "cup" | "tbsp" | "tsp"; to: "g" | "oz" };

const ING = ingredients as Ingredient[];
const PAIRS = pairs as Pair[];

export function getStaticPaths() {
  const paths: { params: { ingredient: string; from: string; to: string } }[] = [];
  for (const ing of ING) {
    for (const p of PAIRS) {
      paths.push({ params: { ingredient: ing.slug, from: p.from, to: p.to } });
    }
  }
  return paths;
}

const { ingredient, from, to } = Astro.params;
const ing = ING.find(i => i.slug === ingredient);
if (!ing) throw new Error(`Ingredient not found: ${ingredient}`);

const fromUnit = from as Pair["from"];
const toUnit = to as Pair["to"];

const baseAmount = 1;

const rows = ing.variants.map(v => ({
  variant: v.name,
  density: v.density,
  value: volumeToMass(baseAmount, fromUnit, v.density, toUnit)
}));

const title = `1 ${fromUnit} ${ing.name} in ${toUnit} (with density assumptions)`;
const description = `Convert ${fromUnit} of ${ing.name} to ${toUnit} using typical density ranges and variants (packing, sifted vs packed, etc.).`;

const canonical = `/cooking/${ing.slug}/${fromUnit}-to-${toUnit}/`;
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonical} />
  </head>
  <body>
    <p><a href="/">Numericano</a> â†’ <a href="/cooking/">Cooking</a></p>

    <h1>1 {fromUnit} {ing.name} in {toUnit}</h1>
    <p>{ing.notes}</p>

    <h2>Quick answer (by variant)</h2>
    <ul>
      {rows.map(r => (
        <li>
          <strong>{r.variant}</strong>: {fmt(r.value)} {toUnit}
          <span> (density {fmt(r.density)} g/mL)</span>
        </li>
      ))}
    </ul>

    <h2>Calculator</h2>
    <p>Enter amount in {fromUnit}:</p>

    <div data-calc>
      <input type="number" step="0.01" value="1" style="width:120px" />
      <ul data-out>
        {rows.map(r => (
          <li data-row data-density={r.density}>
            <strong>{r.variant}</strong>: <span data-val>{fmt(r.value)}</span> {toUnit}
          </li>
        ))}
      </ul>
    </div>

    <script>
      const root = document.querySelector("[data-calc]");
      if (root) {
        const input = root.querySelector("input");
        const items = [...root.querySelectorAll("[data-row]")];

        const fromUnit = "{fromUnit}";
        const toUnit = "{toUnit}";

        const ML_PER = { tsp: 4.92892159375, tbsp: 14.78676478125, cup: 236.5882365 };
        const OZ = 28.349523125;

        const fmt = (x) => {
          const s = x.toFixed(2);
          return s.replace(/\.00$/, "").replace(/(\.\d)0$/, "$1");
        };

        function recalc() {
          const amt = Number(input.value || "0");
          for (const li of items) {
            const density = Number(li.getAttribute("data-density"));
            const ml = amt * ML_PER[fromUnit];
            const g = ml * density;
            const out = (toUnit === "g") ? g : (g / OZ);
            li.querySelector("[data-val]").textContent = fmt(out);
          }
        }

        input.addEventListener("input", recalc);
        recalc();
      }
    </script>

    <h2>Related</h2>
    <ul>
      <li><a href={`/ingredients/${ing.slug}/`}>{ing.name} density & variants</a></li>
      <li><a href="/cooking/">Cooking hub</a></li>
    </ul>
  </body>
</html>
